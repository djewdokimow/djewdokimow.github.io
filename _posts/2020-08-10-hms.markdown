---
layout: post
title:  "Huawei Mobile Services"
date:   2020-08-10 00:10:00 +0200
categories: Android
---

(Tekst pilotażowy, niedokończony, w trakcie edycji)

Najnowsze telefony Huawei (Huawei P40 i P40 Pro, seria Mate 30, Mate Xs oraz Honor 30) nie mają dostępu do Sklepu Play do Usług Google Play. Oznacza to mniej więcej tyle, że jeśli stworzyłeś aplikację na system Android i wrzuciłeś ją tylko do Sklepu Play, to użytkownicy najnowszych telefonów Huawei nie będą ich mogli jej pobrać. Specjalnie dla nich trzeba teraz aplikację wrzucać do Huawei App Gallery, jednak bardzo możliwe, że wrzucenie tego samego pliku do obu sklepów nie rozwiąże całkowicie problemu. Jeśli masz w swojej aplikacji którąkolwiek z tych funkcjonalności:
- mapy
- pobieranie lokalizacji
- geofencing
- komunikaty push
- app linki
- logowanie kontem
- reklamy
- analitykę
- skanowanie kodów kreskowych i QR
- zakupy w aplikacji
- platność kartą
- instant app
- zapis danych do chmury

i za dostarczenie jej odpowiada biblioteka Google Play Services, to możesz być pewien, że nie będą one działać na najnowszych telefonach Huawei.

Należy się spodziewać próśb od klientów - a najlepiej wycenić narzut czasowy i samemu im to zaproponować - o dostosowanie aplikacji do działania na smartfonach Huawei. Przekonanie ich do realizacji nie powinno być trudne. Jeśli masz w swoim projekcie podpiętą analitykę, jesteś w stanie bardzo szybko sprawdzić, jaki udział użytkowników aplikacji stanowili do tej pory posiadacze telefonów marki Huawei. Jeśli w twojej aplikacji można coś kupić, można przefiltrować w panelu Firebase, ile pieniędzy wydali ci użytkownicy. O ile klient nie będzie musiał zapłacić za rozbudowę więcej niż może zarobić, najprawdopodobniej się na nią zgodzi. Możliwe, że w najbliższym czasie nastąpi odwrót użytkowników od Huawei z powodu braku dostępności aplikacji, ale póki co nic na to nie wskazuje. Firma odnotowała w tym roku spadek liczby sprzedanych urządzeń, jednak procentowy udział na rynku się nie zmienił. Takie spadki odnotował właściwie każdy producent smartfonów i są one spowodowane rececją światowej gospodarki. Huawei ciągle pozostaje drugą po Samsungu marką smartfonów z Androidem. Dbania o posiadaczy jego urządzeń będzie wiązało się z większymi nakładami czasowymi niż ze wspierania urządzeń sprzed pięciu lat, jednak korzyści też będą większe.

W ostatnim czasie zajmowałem się rozbudową dwóch aplikacji, by na urządzeniach Huawei aplikacje odbierały powiadomienia push, można było logować się kontem Huawei ID, dało się nimi odczytywać kody QR i aby działało raportowanie analityki. Po zakończeniu prac postanowiłem podzielić się swoimi przemyśleniami na temat problemów, z jakimi musiałem się zmierzyć, przeprowadzając migrację do HMS. Nie sądzę, bym mógł spotkać się już ze wszystkimi możliwymi i zaproponował w tym tekście jedyne słuszne rozwiązania (i mógł je opisać w krótkim czasie w sposób wyczerpujący), w związku z tym ten tekst będzie stale aktualizowany.

# Jak się do tego zabrać?

Pierwsza rzeczą, jaką powinieneś zrobić, to [instalacja wtyczki w Android Studio][hms-toolkit]. Umożliwia ona wygenerowanie kodu, przekonwertowanie go do HMS, import i aktualizację bibliotek oraz - możliwe, że najważniejsze - debugowanie w chmurze na prawdziwych urządzeniach Huawei bez Usług Google Play.

Przeniesienia do HMS możesz dokonać na kilka sposobów. To, które wybierzesz, najprawdopodobniej będzie zależało od tego, jak dużo bibliotek musisz zastąpić ich HMS-owymi odpowiednikami i jak dużo czasu możesz poświęcić na wprowadzanie tych zmian.
1. Ręcznie.
- Tworzysz nowy flavor Gradle przeznaczony do budowania wersji do HUAWEI AppGallery.
- Dołączasz biblioteki Huawei, najlepiej tylko do tego konkretnego flavoru (`huaweiImplementation 'com.huawei.hms:maps:{version}`, jeśli flavor został nazwany „huawei”)
- Tworzysz wspólne interfejsy dla implementacji do Google Play Store i HUAWEI AppGallery.
- Posiłkując się instrukcjami przygotowanymi przez Huawei ([takimi jak te][codelab-example]), implementujesz klasy używane przez flavor Huawei.
: Jest to najbardziej czasochłonne podejście i grozi przypadkowym pominięciem kodu wymagającego przeniesienia. Sprawdzi się najlepiej w przypadku, gdy musisz przenieść tylko jedną funkcjonalność - np. tylko mapy.
2. Z użyciem HMS Convertor.
- Tylko do HMS API
: Takie podejście przy całkowicie automatycznej konwersji sprawdzi się tylko wtedy, gdy na wersje do obu sklepów mamy oddzielne projekty w repozytorium. W innym wypadku musielibyśmy przywracać ręcznie implementacje klas Google. Nie jest to złe podejście, zwłaszcza jeśli nie znamy dobrze API HMS.
- Generując kod działający na telefonach z Google Play Service i Huawei Mobile Services (HMS lub GMS first).
: Podejście umożliwiające utrzymywanie w ramach jednego projektu i jednego flavoru Gradle obu wersji aplikacji. Mało kuszące, kiedy zauważy się, że biblioteki Huawei wymagają wyższego minimalnego API. Nie powinniśmy zabierać użytkownikom starszych telefonów innej marki możliwości aktualizacji tylko dlatego, że umieszczamy inną wersję do Huawei App Gallery. Rozwiązanie polega na zaimportowaniu do projektu modułu, który decyduje, jakich usług konkretnie użyć - HMS czy Usług Google Play. HMS Toolkit posiada narzędzie do aktualizacji tych modułów, problemem tego rozwiązania jest jednak to, że wymaga zmiany kodu używającego Usług Google Play. Istnieje duże prawdopodobieństwo, że bugi w bibliotece HMS spowodują wadliwe działanie aplikacji ze Sklepu Play.

# Jak testować?

Oczywiście najlepiej kupić któryś z ostatnich Huawei, ale jeśli nie mamy takiej możliwości, pomocna będzie wspomniana już [wtyczka][hms-toolkit]. Usługa [Cloud Debugging][cloud-debugging] umożliwia ona testowanie aplikacji na telefonie z farmy urządzeń. Usługa jest darmowa. Jedynym ograniczeniami jest konieczność zmiany urządzenia co dwie godziny i ponownego zalogowania po dwudziestu godzinach korzystania. Urządzenie jest widoczne w Android Studio, można stawiać breakpointy i czytać Logcata, tak jakby ten telefon miało się na biurku.

Brakuje nieco możliwości uruchomienia zwykłego emulatora z EMUI z poziomu AVD Manager. Największą wadą usługi jest jej powolne działanie - długi czas reakcji na kliknięcie czy długi czas pobierania podczas debugowania aplikacji. Jedynym wyjściem będzie skorzystanie z rozwiązania typu [Genymotion][genymotion].

# Problemy

- Ograniczone opcje clusteringu na mapach

[TODO]

(Rozwinę potem, na razie napiszę tylko, że tymczasowym rozwiązaniem problemu może być ta [„biblioteka”][map-clustering])

[hms-toolkit]: https://developer.huawei.com/consumer/en/huawei-toolkit/
[codelab-example]: https://developer.huawei.com/consumer/en/codelab/HMSMapKit/index.html#0
[genymotion]: https://www.genymotion.com/
[hms-cloud-debugging]: https://developer.huawei.com/consumer/en/doc/development/Tools-Guides/cloud-debugging-0000001051084360
[map-clustering]: https://github.com/hunterxxx/huawei-map-clustering